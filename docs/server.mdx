---
title: 'Self-Hosted Server'
order: 60
---

## Self-Hosted Server

Server is a typical server. A Server receives changes from Clients, stores them in DB, and propagates them to Clients who subscribe to Documents.

### Getting started

#### Install pre-built binaries

The easiest way to install Yorkie is from pre-built binaries:

1. Download the compressed archive file for your platform from [Releases](https://github.com/yorkie-team/yorkie/releases).
2. Unpack the archive file. This results in a directory containing the binaries.
3. Add the executable binaries to your PATH. For example, rename and/or move the binaries to a directory in your PATH (like /usr/local/bin), or add the directory created from the previous step to your PATH.
4. Test if Yorkie is in your PATH in shell:

```bash
$ yorkie version
Yorkie: {{site.version}}
Commit: ...
Go: ...
Build date: ...
```

#### Install via Homebrew

[Homebrew](https://brew.sh/) is a free and open-source package management system for Mac OS X. Install the official [Yorkie formula](https://formulae.brew.sh/formula/yorkie) in Terminal.

To update Yorkie to the latest version, update Homebrew first.

```bash
$ brew update
```

Now, install Yorkie.

```bash
$ brew install yorkie
```

Verify that the installation worked by opening a new Terminal session and trying Yorkie's available subcommands.

```bash
$ yorkie version
Yorkie: {{site.version}}
Commit: ...
Go: ...
Build date: ...
```

#### Commands (CLI)

Yorkie is controlled via a very easy-to-use command-line interface (CLI). Yorkie is just a single command-line application `yorkie`, which takes a subcommand such as `server`.

The Yorkie CLI is a well-behaved command-line application. In erroneous cases, a non-zero exit status will be returned. It also responds to `-h` and `---help` as you'd most likely expect.

To get help for any specific command, pass the `-h` flag to the relevant subcommand. For example, to see help about the `server` subcommand:

```bash
$ yorkie server --help
Start Yorkie server

Usage:
  yorkie server [options] [flags]

Flags:
      --auth-webhook-cache-auth-ttl duration         TTL value to set when caching authorized webhook response. (default 10s)
      --auth-webhook-cache-size int                  The cache size of the authorization webhook. (default 5000)
      --auth-webhook-cache-unauth-ttl duration       TTL value to set when caching unauthorized webhook response. (default 10s)
      --auth-webhook-max-retries uint                Maximum number of retries for an authorization webhook. (default 10)
      --auth-webhook-max-wait-interval duration      Maximum wait interval for authorization webhook. (default 3s)
      --backend-snapshot-interval uint               Interval of changes to create a snapshot. (default 1000)
      --backend-snapshot-threshold uint              Threshold that determines if changes should be sent with snapshot when the number of changes is greater than this value. (default 500)
      --backend-use-default-project                  Whether to use the default project. Even if public key is not provided from the client, the default project will be used for the request. (default true)
  -c, --config string                                Config path
      --enable-pprof                                 Enable runtime profiling data via HTTP server.
      --etcd-dial-timeout duration                   ETCD's dial timeout (default 5s)
      --etcd-endpoints strings                       Comma separated list of etcd endpoints
      --etcd-lock-lease-time duration                ETCD's lease time for lock (default 30s)
      --etcd-password string                         ETCD's password
      --etcd-username string                         ETCD's user name
  -h, --help                                         help for server
      --housekeeping-candidates-limit int            candidates limit for a single housekeeping run (default 500)
      --housekeeping-deactivate-threshold duration   time after which clients are considered deactivate (default 168h0m0s)
      --housekeeping-interval duration               housekeeping interval between housekeeping runs (default 1m0s)
  -l, --log-level string                             Log level: debug, info, warn, error, panic, fatal (default "info")
      --mongo-connection-timeout duration            Mongo DB's connection timeout (default 5s)
      --mongo-connection-uri string                  MongoDB's connection URI
      --mongo-ping-timeout duration                  Mongo DB's ping timeout (default 5s)
      --mongo-yorkie-database string                 Yorkie's database name in MongoDB (default "yorkie-meta")
      --profiling-port int                           Profiling port (default 11102)
      --rpc-cert-file string                         RPC certification file's path
      --rpc-key-file string                          RPC key file's path
      --rpc-max-requests-bytes uint                  Maximum client request size in bytes the server will accept. (default 4194304)
      --rpc-port int                                 RPC port (default 11101)
```

#### Running a Server

Next, let's start a Yorkie Server. The Server handles administrative requests such as project maintenance, and it continues to run until it's told to quit with termination commands such as Ctrl+C.

```bash
$ yorkie server

backend created: id: c6ljcdl94818baveba8g, rpc: localhost:11101: db: memory
serving admin on 11103
serving RPC on 11101
serving profiling on 11102
```

The Server stores its data using an in-memory DB, which does not provide durability by default.

### Persistence

If you start the Server with a MongoDB address, you can permanently save the data stored by Yorkie.

> To start MongoDB, `docker-compose -f docker/docker-compose.yml up --build -d` in [the project root](https://github.com/yorkie-team/yorkie).

Then, start a Yorkie Server with `--mongo-connection-uri` flag to connect the MongoDB.

```bash
$ yorkie server --mongo-connection-uri mongodb://localhost:27017

MongoDB connected, URI: mongodb://localhost:27017, DB: yorkie-meta
backend created: id: c6ljibt948102kkt9neg, rpc: localhost:11101: db: mongodb://localhost:27017
serving profiling on 11102
serving RPC on 11101
```

### Server for Web

Server uses [gRPC](https://grpc.io/) to provide an API that Clients can connect to. Since it is currently impossible to implement the HTTP/2 gRPC in some browsers, [Envoy](https://www.envoyproxy.io/) is required for web. For more details: [gRPC-web](https://grpc.io/blog/state-of-grpc-web/)

This page shows how to start the Server for web. Overall structure is as follows:

```
 Browser            Envoy                  Server
┌────────┐         ┌──────────────┐       ┌───────────┐
│gRPC-web├─HTTP1.1─┤gRPC-web Proxy├─HTTP2─┤gRPC Server│
└────────┘         └──────────────┘       └───────────┘
```

Configuring Envoy by hand with its config file is cumbersome, but using [Docker Compose](https://docs.docker.com/compose/) makes it easy.

<Alert status="warning">If docker compose is not installed, install it : [Install Docker Compose](https://docs.docker.com/compose/install/)</Alert>

First, download all manifests files from [docker folder](https://github.com/yorkie-team/yorkie-team.github.io/tree/main/docker). Then, execute the following command in the folder containing the downloaded file.

```bash
$ docker-compose up --build -d

Starting yorkie ... done
Starting envoy  ... done
```

This will launch Yorkie(Server) and envoy containers on your environment.

```bash
$ docker ps

IMAGE                      COMMAND                  PORTS                                  NAMES
grpcweb:envoy              "/usr/local/bin/envo…"   0.0.0.0:8080->9090/tcp                 envoy
yorkieteam/yorkie:latest   "yorkie server --ena…"   0.0.0.0:11101-11103->11101-11103/tcp   yorkie
```

Then, the ports of the services are bound to the host environment.

- 8080: gRPC-web port for SDK
- 9090: gRPC-web port for Web Admin([Yorkie House](https://github.com/yorkie-team/yorkie-house))
- 11101: gRPC port for SDK
- 11102: HTML port for profiling Server
- 11103: gRPC port for admin Server

<Alert status="warning">Server stores its data using an in-memory DB, which does not provide durability. If you want to store data permanently, please refer to [Running Server With MongoDB](/docs/server#running-server-with-mongodb)</Alert>

Now, let's create a Client with address `localhost:8080`.

```javascript
const client = new yorkie.Client('localhost:8080');
await client.activate();
```

Next, let's take a look at the [JS SDK](/docs/js-sdk).

### Monitoring

Server exports metrics under the `/metrics` path on its profiling port.
The metrics can be fetched with curl:

```bash
$ curl http://localhost:11102/metrics

yorkie_server_version{server_version="{{site.version}}"} 1
# HELP yorkie_pushpull_received_changes_total The total count of changes included
# TYPE yorkie_pushpull_received_changes_total counter
yorkie_pushpull_received_changes_total 6
...
```

This metrics can be collected from [Prometheus](https://prometheus.io/).

Running [Prometheus](https://prometheus.io/) and [Grafana](https://grafana.com/oss/grafana/) is the easiest way to monitor Server's metrics.

First, download all manifests files from [docker folder](https://github.com/yorkie-team/yorkie-team.github.io/tree/main/docker). Then, start the applications with `docker-compose`:

```bash
$ docker-compose -f docker-compose-monitoring.yml up --build -d

Creating prometheus ... done
Creating grafana    ... done
```

Now, Prometheus will collect Server metrics every 10 seconds.

Grafana has a built-in Prometheus support; just add a Prometheus data source:

```
Name:   prometheus
Type:   Prometheus
Url:    http://localhost:9090
Access: proxy
```

Then, import the [default Yorkie dashboard template](https://github.com/yorkie-team/yorkie-team.github.io/tree/main/docker/yorkie-dashboard.json) and customize it. For instance, if Prometheus data source name is `my-prometheus`, the datasource field values in JSON also need to be `my-prometheus`.

Sample dashboard:

<Image alt="dashboard" src="/assets/images/docs/dashboard.png" width={600} height={626} style={{ maxWidth: '600px' }} />

### Cluster Mode

In a production environment, it is generally expected that more than one server handles requests. Even if a Server goes down, the other Servers must be able to handle the request. We can achieve that by setting up Servers with Cluster-Mode.

This page describes how to set up a cluster of Servers. An example of the cluster is as follows:

```
                        ┌───────────┐
                        │  ┌──────┐ │
                      ┌─┼─►│Server│ │    ┌───────┐
                      │ │  └──▲───┘ │ ┌─►│MongoDB│
┌──────┐  ┌────────┐  │ │     │     │ │  └───────┘
│Client├─►│Load    ├──┤ │ Broadcast ├─┤
└──────┘  │Balancer│  │ │ DocEvents │ │  ┌────┐
          └────────┘  │ │     │     │ └─►│etcd│
                      │ │  ┌──▼───┐ │    └────┘
                      └─┼─►│Server│ │
                        │  └──────┘ │
                        └───────────┘
```

- Load Balancer: It is responsible for distributing the load of the requests to the Servers.
- Broadcast Channel: It is responsible for broadcasting the events to all Servers.
- MongoDB: It stores the data of Yorkie.
- etcd: It is used to store the state of the cluster such as MemberMap, SubscriptionMap, etc.

First, we need components such as etcd, MongoDB, and Load Balancer in order to set up the cluster.

Various types of load balancer can be used for the cluster. For CodePair, We have configured the cluster on AWS, so we use [ALB](https://docs.aws.amazon.com/elasticloadbalancing/latest/application/introduction.html) as Load Balancer.

> For testing cluster mode, we can use Docker Compose to run applications such as etcd and MongoDB. To start them, type `docker-compose -f docker/docker-compose-ci.yml up --build -d` in [the project root](https://github.com/yorkie-team/yorkie).

If etcd and MongoDB are ready, we can run Servers in cluster mode. In the terminal, run the Server with flags for MongoDB and etcd.

```bash
$ yorkie server --mongodb-uri mongodb://localhost:27017 --etcd-endpoints http://localhost:2379

MongoDB connected, URI: mongodb://localhost:27017, DB: yorkie-meta
etcd connected, URI: [http://localhost:2379]
backend created: id: c6n20nnblaroaopqdbp0, rpc: localhost:11101: db: mongodb://localhost:27017
serving profiling on 11102
serving RPC on 11101
```

Open a new terminal and run the Server by using `xxx-port` flags to avoid ports conflicts.

```bash
$ yorkie server --rpc-port 21101 --profiling-port 21102 --mongo-connection-uri mongodb://localhost:27017 --etcd-endpoints http://localhost:2379

MongoDB connected, URI: mongodb://localhost:27017, DB: yorkie-meta
etcd connected, URI: [http://localhost:2379]
backend created: id: c6n25o7blarohq3ve250, rpc: localhost:21101: db: mongodb://localhost:27017
serving profiling on 21102
serving RPC on 21101
```

Now both Servers are ready to receive requests from Clients.
